name: CI Pipeline (Split Jobs)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_TAG: ${{ github.sha }}

# =================================================
# ðŸ”¹ ADSERVICE PIPELINE
# =================================================
jobs:
  ad_checkout:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

  ad_lint:
    runs-on: ubuntu-latest
    needs: ad_checkout
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/DevSkim-Action@v1
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: devskim-results.sarif

  ad_build:
    runs-on: ubuntu-latest
    needs: ad_lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 20

      - uses: gradle/actions/setup-gradle@v4

      - name: Build
        working-directory: src/adservice
        run: |
          chmod +x gradlew
          ./gradlew installDist

  ad_validate_gradle:
    runs-on: ubuntu-latest
    needs: ad_build
    steps:
      - uses: actions/checkout@v4
      - uses: gradle/wrapper-validation-action@v2
        with:
          working-directory: src/adservice

  ad_docker_build:
    runs-on: ubuntu-latest
    needs: ad_validate_gradle
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t sharuelement/adservice:${{ env.IMAGE_TAG }} src/adservice
      - run: docker save sharuelement/adservice:${{ env.IMAGE_TAG }} -o adservice.tar
      - uses: actions/upload-artifact@v4
        with:
          name: adservice-image
          path: adservice.tar

  ad_trivy:
    runs-on: ubuntu-latest
    needs: ad_docker_build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: adservice-image
      - run: docker load -i adservice.tar
      - uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: sharuelement/adservice:${{ env.IMAGE_TAG }}
          severity: CRITICAL,HIGH
          exit-code: 0

  ad_push:
    runs-on: ubuntu-latest
    needs: ad_trivy
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: adservice-image
      - run: docker load -i adservice.tar
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - run: docker push sharuelement/adservice:${{ env.IMAGE_TAG }}

# =================================================
# ðŸ”¹ CARTSERVICE PIPELINE
# =================================================
  cart_checkout:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

  cart_build:
    runs-on: ubuntu-latest
    needs: cart_checkout
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 20

      - uses: gradle/actions/setup-gradle@v4

      - name: Build
        working-directory: src/cartservice
        run: |
          chmod +x gradlew
          ./gradlew installDist

  cart_docker_build:
    runs-on: ubuntu-latest
    needs: cart_build
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t sharuelement/cartservice:${{ env.IMAGE_TAG }} src/cartservice
      - run: docker save sharuelement/cartservice:${{ env.IMAGE_TAG }} -o cartservice.tar
      - uses: actions/upload-artifact@v4
        with:
          name: cartservice-image
          path: cartservice.tar

  cart_push:
    runs-on: ubuntu-latest
    needs: cart_docker_build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: cartservice-image
      - run: docker load -i cartservice.tar
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - run: docker push sharuelement/cartservice:${{ env.IMAGE_TAG }}
